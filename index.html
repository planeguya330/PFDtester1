<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A320 Cockpit Simulator - Interactive</title>
    <style>
        /* --- 1. GLOBAL SETTINGS --- */
        :root {
            --ab-blue: #2d6b9f;    /* Horizon Sky */
            --ab-brown: #8b5e34;   /* Horizon Ground */
            --ab-cyan: #00ffff;    /* Flight Director / Text */
            --ab-green: #2aff00;   /* Active Modes */
            --ab-amber: #ffaa00;   /* Warnings */
            --ab-dark: #0a0a0a;    /* Screen BG */
            --ab-panel: #2e2e2e;   /* Cockpit Panel Color */
        }

        body {
            background-color: #111;
            color: white;
            font-family: 'Consolas', monospace;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            user-select: none; /* Crucial for drag interactions */
        }

        /* --- 2. LAYOUT --- */
        .cockpit {
            display: flex;
            gap: 20px;
            padding: 30px;
            background-color: var(--ab-panel);
            border-radius: 20px;
            border: 4px solid #444;
            box-shadow: inset 0 0 60px rgba(0,0,0,0.8);
            align-items: flex-end;
        }

        /* --- 3. SCREENS (PFD & ND) --- */
        .screen-bezel {
            width: 320px;
            height: 320px;
            background-color: #000;
            border: 10px solid #555;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 15px #000;
        }

        /* CRT Scanline Effect */
        .screen-bezel::after {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 99;
        }

        /* --- PFD SPECIFICS --- */
        #pfd-content {
            width: 100%; height: 100%;
            position: relative;
        }

        .horizon-container {
            position: absolute;
            top: 0; left: 15%; width: 70%; height: 100%;
            overflow: hidden;
            border-left: 1px solid #333;
            border-right: 1px solid #333;
        }

        .artificial-horizon {
            position: absolute;
            top: 50%; left: 50%;
            width: 600px; height: 800px;
            background: linear-gradient(to bottom, var(--ab-blue) 50%, var(--ab-brown) 50%);
            transform: translate(-50%, -50%);
            will-change: transform;
            transition: transform 0.05s linear; /* Smooth movement */
        }

        .pitch-lines {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 100%; height: 100%;
        }
        
        .p-line {
            position: absolute;
            left: 50%; transform: translateX(-50%);
            background-color: white;
            height: 2px;
            width: 40px;
            color: white; /* Pitch text */
            font-size: 10px;
        }
        /* Pitch scale: 10 deg = approx 80px */
        .p-10 { top: calc(50% - 80px); }
        .p-20 { top: calc(50% - 160px); width: 60px; }
        .p-n10 { top: calc(50% + 80px); }
        .p-n20 { top: calc(50% + 160px); width: 60px; }
        
        .p-line::after, .p-line::before {
            content: attr(data-val);
            position: absolute;
            top: -7px;
        }
        .p-line::after { right: -15px; }
        .p-line::before { left: -15px; }


        .yellow-aircraft {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 120px; height: 30px;
            z-index: 20;
        }
        .y-left, .y-right { position: absolute; top: 12px; width: 40px; height: 6px; background: black; border: 2px solid #FFD700; }
        .y-left { left: 0; }
        .y-right { right: 0; }
        .y-dot { position: absolute; left: 56px; top: 10px; width: 8px; height: 8px; background: black; border: 2px solid #FFD700; border-radius: 50%; }

        /* TAPES */
        .tape {
            position: absolute; top: 10%; bottom: 10%;
            width: 45px; background: rgba(0,0,0,0.5);
            overflow: hidden; z-index: 30;
        }
        .tape-l { left: 0; border-right: 1px solid white; }
        .tape-r { right: 0; border-left: 1px solid white; }
        
        .tape-strip {
            position: absolute; left: 0; width: 100%;
            display: flex; flex-direction: column-reverse;
            transition: transform 0.1s linear;
        }
        .t-tick {
            height: 39px;
            border-top: 1px solid white;
            text-align: right; font-size: 11px; padding-right: 2px; color: white;
            box-sizing: border-box;
        }
        
        .tape-window {
            position: absolute; top: 50%; height: 30px; width: 55px;
            background: black; border: 2px solid yellow;
            color: var(--ab-green); font-size: 16px; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            transform: translateY(-50%); z-index: 35;
        }
        .tw-l { left: 0; }
        .tw-r { right: 0; }

        /* --- ND SPECIFICS --- */
        #nd-content {
            background-color: #000;
            width: 100%; height: 100%;
            position: relative;
        }
        
        .nd-rose {
            position: absolute;
            bottom: -80px; left: 50%;
            width: 380px; height: 380px;
            border: 2px solid white;
            border-radius: 50%;
            transform: translateX(-50%);
            overflow: hidden;
        }
        
        .map-canvas {
            position: absolute;
            top: 50%; left: 50%;
            width: 1000px; height: 1000px;
            transform: translate(-50%, -50%);
            transition: transform 0.1s linear; /* Apply transition here */
        }
        
        .nd-wpt {
            position: absolute;
            width: 10px; height: 10px;
            border: 2px solid magenta;
            transform: translate(-50%, -50%);
            color: magenta;
            font-size: 12px;
            text-align: center;
        }
        .nd-wpt div { margin-top: 12px; white-space: nowrap; }

        .nd-plane {
            position: absolute;
            bottom: 105px; left: 50%;
            transform: translateX(-50%);
            font-size: 32px; color: yellow;
            z-index: 50;
            text-shadow: 0 2px 0 black;
        }
        
        .nd-data {
            position: absolute; top: 10px; left: 10px;
            color: var(--ab-green); font-size: 14px;
        }

        /* --- 4. THROTTLE QUADRANT --- */
        .throttle-quadrant {
            width: 140px;
            height: 320px;
            background: linear-gradient(to bottom, #222, #111);
            border-radius: 10px;
            border: 2px solid #555;
            position: relative;
            display: flex;
            justify-content: center;
        }

        /* The Markings (TOGA, FLX, CL, 0) */
        .tq-markings {
            position: absolute;
            left: 5px; top: 0; bottom: 0; width: 30px;
            color: white; font-size: 10px; font-weight: bold;
            display: flex; flex-direction: column; justify-content: space-between;
            padding: 20px 0; box-sizing: border-box;
            z-index: 1;
            pointer-events: none;
        }
        .tq-markings div { border-bottom: 1px solid #555; width: 100%; margin-bottom: 5px;}

        /* The Track */
        .tq-track {
            width: 60px;
            height: 280px;
            background: #000;
            margin-top: 20px;
            border-radius: 5px;
            position: relative;
            box-shadow: inset 0 0 10px #000;
        }

        /* The Levers (Interactive) */
        #thrust-lever {
            position: absolute;
            bottom: 0; left: 0; width: 100%; height: 60px;
            background: linear-gradient(to right, #ccc, #eee, #ccc);
            border-radius: 5px;
            cursor: grab;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            touch-action: none;
            transition: top 0.05s linear; /* Smooth visual update for throttle */
        }
        
        #thrust-lever::after {
            content: "";
            width: 50px; height: 50px;
            border-radius: 50%;
            background: linear-gradient(to bottom, #d22, #900);
            border: 2px solid #444;
        }
        
        #thrust-lever:active { cursor: grabbing; background: #bbb; }

        /* --- 5. JOYSTICK --- */
        .controls-right {
            display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        .joystick-base {
            width: 120px; height: 120px;
            background: radial-gradient(circle at 30% 30%, #444, #222);
            border-radius: 50%;
            border: 4px solid #111;
            position: relative;
        }
        .joystick-handle {
            width: 60px; height: 60px;
            background: radial-gradient(circle at 30% 30%, #555, #111);
            border-radius: 50%;
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            cursor: pointer;
            touch-action: none;
            transition: transform 0.05s linear; /* Smooth visual return */
        }

    </style>
</head>
<body>

    <div class="cockpit">
        
        <div class="screen-bezel">
            <div id="pfd-content">
                <div class="horizon-container">
                    <div class="artificial-horizon" id="horizon">
                        <div class="pitch-lines">
                            <div class="p-line p-20" data-val="20"></div>
                            <div class="p-line p-10" data-val="10"></div>
                            <div class="p-line" style="width: 100px;" data-val="0"></div> <div class="p-line p-n10" data-val="10"></div>
                            <div class="p-line p-n20" data-val="20"></div>
                        </div>
                    </div>
                </div>

                <div class="yellow-aircraft">
                    <div class="y-left"></div>
                    <div class="y-dot"></div>
                    <div class="y-right"></div>
                </div>

                <div class="tape tape-l">
                    <div class="tape-strip" id="speed-strip">
                        </div>
                </div>
                <div class="tape-window tw-l" id="spd-val">180</div>

                <div class="tape tape-r">
                    <div class="tape-strip" id="alt-strip">
                        </div>
                </div>
                <div class="tape-window tw-r" id="alt-val">000</div>
                
                <div style="position:absolute; top:50%; left:50%; width: 200px; height: 2px; background:var(--ab-green); transform: translate(-50%, -50%); opacity: 0.6;"></div>
                <div style="position:absolute; top:50%; left:50%; width: 2px; height: 200px; background:var(--ab-green); transform: translate(-50%, -50%); opacity: 0.6;"></div>
            </div>
        </div>

        <div class="throttle-quadrant">
            <div class="tq-markings">
                <div style="margin-top: 0;">TOGA</div>
                <div style="margin-top: 20px;">FLX</div>
                <div style="margin-top: 50px;">CL</div>
                <div style="margin-top: auto;">IDLE</div>
            </div>
            <div class="tq-track" id="tq-track">
                <div id="thrust-lever"></div>
            </div>
        </div>

        <div class="screen-bezel">
            <div id="nd-content">
                <div class="nd-data">
                    <div id="nd-gs">GS 180</div>
                    <div id="nd-tas">TAS 180</div>
                </div>
                <div class="nd-plane">âœˆ</div>
                
                <div class="nd-rose">
                    <div class="map-canvas" id="nd-map">
                        </div>
                    <div style="position: absolute; top: 10px; left: 50%; transform: translateX(-50%); color: white;">N</div>
                    <div style="position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); color: white;">S</div>
                    <div style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: white;">W</div>
                    <div style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: white;">E</div>
                </div>
            </div>
        </div>

        <div class="controls-right">
            <div class="joystick-base" id="joy-base">
                <div class="joystick-handle" id="joy-handle"></div>
            </div>
            <div style="font-size: 12px; color: #888;">SIDE STICK</div>
        </div>

    </div>

    <script>
        /* --- SIMULATION CONSTANTS --- */
        const MAX_SPEED = 350; // Knots
        const DRAG_FACTOR = 0.05; // Air resistance
        const THRUST_POWER = 1.5; // Engine acceleration power
        const GRAVITY_DRAG = 0.1; // Speed loss when climbing

        /* --- INITIAL STATE (Requested) --- */
        let sim = {
            spd: 180, // Requested 180 kts
            alt: 0,   // Requested 0 ft
            hdg: 0,
            pitch: 0,
            bank: 0,
            throttle: 0, // IDLE position (0.0)
            x: 0, y: 0
        };

        let inputs = {
            stickX: 0, stickY: 0,
            isDraggingStick: false,
            isDraggingThr: false
        };

        /* --- SETUP DOM --- */
        const els = {
            spdStrip: document.getElementById('speed-strip'),
            altStrip: document.getElementById('alt-strip'),
            spdVal: document.getElementById('spd-val'),
            altVal: document.getElementById('alt-val'),
            horizon: document.getElementById('horizon'),
            map: document.getElementById('nd-map'),
            joyHandle: document.getElementById('joy-handle'),
            joyBase: document.getElementById('joy-base'),
            thrLever: document.getElementById('thrust-lever'),
            tqTrack: document.getElementById('tq-track'),
            gsText: document.getElementById('nd-gs'),
            tasText: document.getElementById('nd-tas')
        };

        // Waypoints Data
        const wpts = [
            {n:'START', x:0, y:0},
            {n:'VOR1', x:0, y:-3000}, 
            {n:'WPT2', x:2000, y:-8000}, 
            {n:'FIX3', x:-2000, y:-12000}, 
            {n:'ARPT', x:0, y:-18000}
        ];

        /* --- INITIALIZATION --- */
        function init() {
            // Build Tapes
            buildTape(els.spdStrip, 0, 400, 20);
            buildTape(els.altStrip, 0, 10000, 100);
            
            // Build Map
            wpts.forEach(p => {
                const el = document.createElement('div');
                el.className = 'nd-wpt';
                el.innerHTML = `<div>${p.n}</div>`;
                el.id = `wp-${p.n}`;
                els.map.appendChild(el);
            });

            // Set initial throttle position to match IDLE (bottom)
            els.thrLever.style.top = `${els.tqTrack.clientHeight - els.thrLever.clientHeight}px`;

            // Initial render
            renderPFD(); 
            renderND();

            requestAnimationFrame(loop);
        }

        function buildTape(container, min, max, step) {
            for(let i=min; i<=max; i+=step) {
                let d = document.createElement('div');
                d.className = 't-tick';
                d.innerText = i;
                container.appendChild(d);
            }
        }

        /* --- INTERACTION HANDLERS (FIXED) --- */

        function getClientCoords(e) {
            if (e.touches && e.touches.length > 0) {
                return { clientX: e.touches[0].clientX, clientY: e.touches[0].clientY };
            }
            return e;
        }

        // --- Joystick Handlers ---
        function handleStickStart(e) {
            e.preventDefault();
            inputs.isDraggingStick = true;
        }
        function handleStickEnd() {
            inputs.isDraggingStick = false;
            // Center Stick on release
            inputs.stickX = 0; inputs.stickY = 0;
            updateStick(0, 0); // Visually center it
        }

        function handleStickMove(e) {
            if (!inputs.isDraggingStick) return;
            e.preventDefault();
            
            const coords = getClientCoords(e);
            const rect = els.joyBase.getBoundingClientRect();
            const cx = rect.left + rect.width / 2;
            const cy = rect.top + rect.height / 2;
            const maxR = 40;
            
            let dx = coords.clientX - cx;
            let dy = coords.clientY - cy;
            const dist = Math.sqrt(dx*dx + dy*dy);
            
            if(dist > maxR) {
                dx = (dx/dist)*maxR; dy = (dy/dist)*maxR;
            }
            
            inputs.stickX = dx/maxR; // -1 to 1
            inputs.stickY = dy/maxR; // -1 to 1
            updateStick(dx, dy);
        }

        function updateStick(x, y) {
            els.joyHandle.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
        }
        
        // Setup Joystick Listeners
        els.joyHandle.addEventListener('mousedown', handleStickStart);
        els.joyHandle.addEventListener('touchstart', handleStickStart);
        window.addEventListener('mouseup', handleStickEnd);
        window.addEventListener('touchend', handleStickEnd);
        window.addEventListener('mousemove', handleStickMove);
        window.addEventListener('touchmove', handleStickMove);

        // --- Throttle Handlers ---
        function handleThrottleStart(e) {
            e.preventDefault();
            inputs.isDraggingThr = true;
        }
        function handleThrottleEnd() {
            inputs.isDraggingThr = false;
            // No centering for throttle, it stays where it is set.
        }

        function handleThrottleMove(e) {
            if (!inputs.isDraggingThr) return;
            e.preventDefault();
            
            const coords = getClientCoords(e);
            const rect = els.tqTrack.getBoundingClientRect();
            
            // Calculate percentage from bottom (0%) to top (100%)
            let val = 1 - ((coords.clientY - rect.top) / rect.height);
            
            if(val < 0) val = 0;
            if(val > 1) val = 1;
            
            sim.throttle = val;
            
            // Snap visual lever
            let px = (1-val) * (rect.height - els.thrLever.clientHeight);
            els.thrLever.style.top = `${px}px`;
        }

        // Setup Throttle Listeners
        els.thrLever.addEventListener('mousedown', handleThrottleStart);
        els.thrLever.addEventListener('touchstart', handleThrottleStart);
        window.addEventListener('mouseup', handleThrottleEnd);
        window.addEventListener('touchend', handleThrottleEnd);
        window.addEventListener('mousemove', handleThrottleMove);
        window.addEventListener('touchmove', handleThrottleMove);
        
        /* --- PHYSICS LOOP --- */
        function loop() {
            updatePhysics();
            renderPFD();
            renderND();
            requestAnimationFrame(loop);
        }

        function updatePhysics() {
            // Pitch & Bank follow stick
            sim.pitch += (inputs.stickY * -20 - sim.pitch) * 0.1;
            sim.bank += (inputs.stickX * 30 - sim.bank) * 0.1;
            
            // Turn
            if(Math.abs(sim.bank) > 2) {
                sim.hdg += sim.bank * 0.05;
                if(sim.hdg >= 360) sim.hdg -= 360;
                if(sim.hdg < 0) sim.hdg += 360;
            }
            
            // Speed Physics
            let thrust = sim.throttle * 2; 
            let drag = (sim.spd / MAX_SPEED) * 0.5;
            let gravity = (sim.pitch / 20) * 0.2;
            
            let accel = thrust - drag - gravity;
            
            sim.spd += accel;
            if(sim.spd < 0) sim.spd = 0;
            if(sim.spd > MAX_SPEED) sim.spd = MAX_SPEED;
            
            // Altitude
            let climbRate = sim.spd * (sim.pitch / 45); // Alt change based on speed and pitch
            sim.alt += climbRate * 0.1; // Slowed down change for visual effect
            if(sim.alt < 0) sim.alt = 0;

            // Position (ND Movement)
            // Knots to "World Pixels per Frame" conversion factor:
            const moveSpeedFactor = 0.03; 
            let moveSpeed = sim.spd * moveSpeedFactor; 
            
            let rad = (sim.hdg) * (Math.PI/180);
            sim.x += Math.sin(rad) * moveSpeed;
            sim.y -= Math.cos(rad) * moveSpeed;
        }

        /* --- RENDERING --- */
        function renderPFD() {
            // Horizon
            let pY = sim.pitch * 8; 
            els.horizon.style.transform = `translate(-50%, calc(-50% + ${pY}px)) rotate(${-sim.bank}deg)`;
            
            // Tapes
            // Speed: 20kts = 40px -> 2px per knot
            els.spdStrip.style.transform = `translateY(${sim.spd * 2}px)`;
            els.spdVal.innerText = Math.round(sim.spd).toString().padStart(3, '0');
            
            // Alt: 100ft = 40px -> 0.4px per ft
            els.altStrip.style.transform = `translateY(${sim.alt * 0.4}px)`;
            els.altVal.innerText = Math.round(sim.alt).toString().padStart(5, '0').slice(0, 3);
        }

        function renderND() {
            els.gsText.innerText = `GS ${Math.round(sim.spd).toString().padStart(3, '0')}`;
            els.tasText.innerText = `TAS ${Math.round(sim.spd + (sim.alt/1000)*2).toString().padStart(3, '0')}`;
            
            // Update Waypoints
            wpts.forEach(p => {
                let el = document.getElementById(`wp-${p.n}`);
                
                // Relative pos to aircraft
                let rx = p.x - sim.x;
                let ry = p.y - sim.y;
                
                // Rotate for Head-Up display
                let rad = (sim.hdg) * (Math.PI/180);
                let screenX = rx * Math.cos(-rad) - ry * Math.sin(-rad);
                let screenY = rx * Math.sin(-rad) + ry * Math.cos(-rad);
                
                // Scale (zoom) and Map Center (500, 500 on 1000x1000 canvas)
                const scale = 0.1; 
                const center = 500;
                let finalX = center + screenX * scale;
                let finalY = center + screenY * scale;

                el.style.left = `${finalX}px`;
                el.style.top = `${finalY}px`;
            });

            // Rotate Map Canvas (Compass Rose)
            els.map.style.transform = `translate(-50%, -50%) rotate(${-sim.hdg}deg)`;
        }

        // Run
        init();
    </script>
</body>
</html>
